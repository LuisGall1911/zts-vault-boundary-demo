# Configure HCP Vault

## Contents

- [Confirm DB secrets engine](#confirm-db-secrets-engine)
- [Confirm Kubernetes secrets engine](#confirm-kubernetes-secrets-engine)
- [Access to EKS with K8s secrets engine](#access-to-eks-with-k8s-secrets-engine)
- [References](#references)

# Confirm DB secrets engine

```bash
export VAULT_NAMESPACE=
export VAULT_ADDR=
export VAULT_TOKEN=
```

Confirm secrets engines.

```bash
vault secrets list
```

Confirm vault roles defined in db secrets engine.

```console
$ vault list postgres/roles/
Keys
----
readonly
readwrite
```

Confirm whether generate credentials via Vault.

```bash
vault read postgres/creds/readonly
```

# Confirm Kubernetes secrets engine

Confirm vault roles defined in k8s secrets engine.

```console
$ vault list kubernetes/roles
Keys
----
all-role
list-pod
```

```bash
vault read kubernetes/roles/all-role -format=json
```

Confirm whether generate service account token via Vault.

```bash
vault write -f kubernetes/creds/all-role kubernetes_namespace=default
```

# Access to EKS with K8s secrets engine

Decode EKS's CA from output (`cluster_certificate_authority_data`).

```bash
base64 --decode <<< "..." > ca.crt
```

Set environment varialbes. 

```bash
export KUBE_API_URL= # refer to output: cluster_endpoint
export REMOTE_USER_TOKEN= # refer to service account token generated by Vault
```

Access to EKS with K8s secrets engine.

```bash
kubectl get pod --certificate-authority=ca.crt --server=$KUBE_API_URL --token=$REMOTE_USER_TOKEN
```

Confirm it doesn't allow to get deployment with this service account token.

```bash
kubectl get deployment --certificate-authority=ca.crt --server=$KUBE_API_URL --token=$REMOTE_USER_TOKEN
```

# References

- [Vault Provider](https://registry.terraform.io/providers/hashicorp/vault/latest/docs)
- [vault_database_secret_backend_connection](https://registry.terraform.io/providers/hashicorp/vault/latest/docs/resources/database_secret_backend_connection)
- [vault_database_secret_backend_role](https://registry.terraform.io/providers/hashicorp/vault/latest/docs/resources/database_secret_backend_role)
- [Vault Credential Brokering Quickstart](https://learn.hashicorp.com/tutorials/boundary/vault-cred-brokering-quickstart)